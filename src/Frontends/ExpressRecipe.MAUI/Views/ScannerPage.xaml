<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:zxing="clr-namespace:ZXing.Net.Maui.Controls;assembly=ZXing.Net.Maui.Controls"
             xmlns:vm="clr-namespace:ExpressRecipe.MAUI.ViewModels"
             x:Class="ExpressRecipe.MAUI.Views.ScannerPage"
             x:DataType="vm:ScannerViewModel"
             Title="Scanner">

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Header with AI toggle -->
        <Frame Grid.Row="0" BackgroundColor="{StaticResource Primary}" Padding="16" CornerRadius="0">
            <Grid ColumnDefinitions="*,Auto">
                <Label Text="Scan or Take a Photo"
                       FontSize="20"
                       FontAttributes="Bold"
                       TextColor="White"
                       VerticalOptions="Center"/>

                <HorizontalStackLayout Grid.Column="1" Spacing="8">
                    <Label Text="Local AI"
                           TextColor="White"
                           VerticalOptions="Center"
                           FontSize="14"/>
                    <Switch IsToggled="{Binding UseLocalAI}"
                            OnColor="{StaticResource Accent}"
                            ThumbColor="White"/>
                </HorizontalStackLayout>
            </Grid>
        </Frame>

        <!-- Main content area - Responsive layout -->
        <Grid Grid.Row="1">
            <!-- Scanner View -->
            <zxing:CameraBarcodeReaderView x:Name="CameraView"
                                          IsVisible="{Binding IsScannerActive}"
                                          IsDetecting="{Binding IsScannerActive}"
                                          BarcodesDetected="OnBarcodesDetected"
                                          CaptureQuality="High">
                <zxing:CameraBarcodeReaderView.BarcodeScannerOptions>
                    <zxing:BarcodeReaderOptions Formats="Ean13,Ean8,Upca,Upce,Code128,Code39,QRCode"
                                                TryHarder="True"
                                                TryInverted="True"
                                                Multiple="False"/>
                </zxing:CameraBarcodeReaderView.BarcodeScannerOptions>

                <!-- Scanning overlay -->
                <Grid IsVisible="{Binding IsScannerActive}">
                    <BoxView Color="Black" Opacity="0.5"/>

                    <!-- Scanning frame -->
                    <Frame WidthRequest="300"
                           HeightRequest="200"
                           BorderColor="White"
                           BackgroundColor="Transparent"
                           CornerRadius="16"
                           Padding="0"
                           HorizontalOptions="Center"
                           VerticalOptions="Center">
                        <Grid>
                            <Label Text="Point camera at barcode"
                                   TextColor="White"
                                   FontSize="16"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Start"
                                   Margin="0,10,0,0"/>
                        </Grid>
                    </Frame>
                </Grid>
            </zxing:CameraBarcodeReaderView>

            <!-- Result View - Responsive for phone and tablet -->
            <ScrollView IsVisible="{Binding HasResult}">
                <VerticalStackLayout Padding="16" Spacing="16">
                    <!-- Product Image (if captured) -->
                    <Frame IsVisible="{Binding ProductImage, Converter={StaticResource IsNotNullConverter}}"
                           Padding="0"
                           CornerRadius="12"
                           HeightRequest="200">
                        <Image Source="{Binding ProductImage, Converter={StaticResource ByteArrayToImageConverter}}"
                               Aspect="AspectFit"/>
                    </Frame>

                    <!-- Allergen Warning Banner -->
                    <Frame IsVisible="{Binding HasAllergenWarning}"
                           BackgroundColor="{StaticResource Error}"
                           Padding="16"
                           CornerRadius="8">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="âš ï¸ ALLERGEN WARNING"
                                   TextColor="White"
                                   FontSize="18"
                                   FontAttributes="Bold"/>
                            <Label Text="{Binding AllergenWarnings, StringFormat='Contains: {0}'}"
                                   TextColor="White"
                                   FontSize="14"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Product Information Card -->
                    <Frame Padding="16" CornerRadius="12" BackgroundColor="{StaticResource Gray100}">
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" RowSpacing="12">
                            <!-- Product Name -->
                            <Label Grid.Row="0"
                                   Text="{Binding ProductName}"
                                   FontSize="24"
                                   FontAttributes="Bold"/>

                            <!-- Brand -->
                            <HorizontalStackLayout Grid.Row="1" Spacing="8" IsVisible="{Binding BrandName, Converter={StaticResource IsNotNullConverter}}">
                                <Label Text="Brand:" FontAttributes="Bold"/>
                                <Label Text="{Binding BrandName}"/>
                            </HorizontalStackLayout>

                            <!-- Category -->
                            <HorizontalStackLayout Grid.Row="2" Spacing="8" IsVisible="{Binding Category, Converter={StaticResource IsNotNullConverter}}">
                                <Label Text="Category:" FontAttributes="Bold"/>
                                <Label Text="{Binding Category}"/>
                            </HorizontalStackLayout>

                            <!-- Barcode -->
                            <HorizontalStackLayout Grid.Row="3" Spacing="8" IsVisible="{Binding ScannedBarcode, Converter={StaticResource IsNotNullConverter}}">
                                <Label Text="Barcode:" FontAttributes="Bold"/>
                                <Label Text="{Binding ScannedBarcode}"/>
                            </HorizontalStackLayout>

                            <!-- Recognition Method -->
                            <HorizontalStackLayout Grid.Row="4" Spacing="8" IsVisible="{Binding RecognitionMethod, Converter={StaticResource IsNotNullConverter}}">
                                <Label Text="Recognized by:" FontAttributes="Bold" FontSize="12" TextColor="{StaticResource Gray600}"/>
                                <Label Text="{Binding RecognitionMethod}" FontSize="12" TextColor="{StaticResource Gray600}"/>
                            </HorizontalStackLayout>
                        </Grid>
                    </Frame>

                    <!-- Actions - Responsive Grid -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12" RowSpacing="12">
                        <Button Grid.Column="0"
                                Text="Add to Inventory"
                                BackgroundColor="{StaticResource Success}"
                                TextColor="White"
                                Command="{Binding AddToInventoryCommand}"/>

                        <Button Grid.Column="1"
                                Text="Add to Shopping"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White"
                                Command="{Binding AddToShoppingListCommand}"/>
                    </Grid>

                    <!-- Reset Button -->
                    <Button Text="Scan Another Product"
                            BackgroundColor="{StaticResource Gray400}"
                            TextColor="White"
                            Command="{Binding ResetScannerCommand}"/>
                </VerticalStackLayout>
            </ScrollView>

            <!-- Processing Indicator -->
            <Grid IsVisible="{Binding IsProcessing}">
                <BoxView Color="Black" Opacity="0.7"/>
                <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="16">
                    <ActivityIndicator IsRunning="True" Color="{StaticResource Primary}" WidthRequest="60" HeightRequest="60"/>
                    <Label Text="Processing..." TextColor="White" FontSize="18"/>
                </VerticalStackLayout>
            </Grid>
        </Grid>

        <!-- Bottom Action Bar - AI Recognition Options -->
        <Grid Grid.Row="2"
              IsVisible="{Binding IsScannerActive}"
              BackgroundColor="{StaticResource Gray100}"
              Padding="16"
              ColumnDefinitions="*,*,*"
              ColumnSpacing="8">

            <Button Grid.Column="0"
                    Text="ðŸ“· Take Photo"
                    Command="{Binding TakePhotoAndRecognizeCommand}"
                    BackgroundColor="{StaticResource Accent}"
                    TextColor="White"
                    FontSize="12"/>

            <Button Grid.Column="1"
                    Text="ðŸ–¼ï¸ Pick Photo"
                    Command="{Binding PickPhotoAndRecognizeCommand}"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    FontSize="12"/>

            <Button Grid.Column="2"
                    Text="ðŸ” Manual Search"
                    BackgroundColor="{StaticResource Gray400}"
                    TextColor="White"
                    FontSize="12"
                    Clicked="OnManualSearchClicked"/>
        </Grid>
    </Grid>
</ContentPage>
