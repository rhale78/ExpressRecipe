<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ExpressRecipe.MAUI.ViewModels"
             x:Class="ExpressRecipe.MAUI.Views.InventoryPage"
             x:DataType="vm:InventoryViewModel"
             Title="Inventory">

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!-- Search and Filter Bar -->
        <Frame Grid.Row="0" Padding="12" Margin="8,8,8,0" CornerRadius="8" BackgroundColor="{StaticResource Gray100}">
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                <SearchBar Grid.Column="0"
                          Placeholder="Search inventory..."
                          Text="{Binding SearchText}"
                          SearchCommand="{Binding FilterItemsCommand}"/>

                <Picker Grid.Column="1"
                       ItemsSource="{Binding Filters}"
                       SelectedItem="{Binding SelectedFilter}"
                       WidthRequest="130"/>
            </Grid>
        </Frame>

        <!-- Expiring Items Alert -->
        <Frame Grid.Row="1"
               IsVisible="{Binding ExpiringItems.Count, Converter={StaticResource IsGreaterThanZeroConverter}}"
               Margin="8,8,8,0"
               Padding="12"
               CornerRadius="8"
               BackgroundColor="{StaticResource Warning}">
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                <Label Grid.Column="0"
                      Text="⚠️"
                      FontSize="24"
                      VerticalOptions="Center"/>

                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                    <Label Text="{Binding ExpiringItems.Count, StringFormat='{0} items expiring soon'}"
                          FontAttributes="Bold"
                          TextColor="White"/>
                    <Label Text="Check expiration dates"
                          FontSize="12"
                          TextColor="White"/>
                </VerticalStackLayout>

                <Button Grid.Column="2"
                       Text="View"
                       BackgroundColor="White"
                       TextColor="{StaticResource Warning}"
                       Padding="12,6"
                       FontSize="12"/>
            </Grid>
        </Frame>

        <!-- Inventory List -->
        <RefreshView Grid.Row="2"
                    IsRefreshing="{Binding IsRefreshing}"
                    Command="{Binding RefreshCommand}">
            <CollectionView ItemsSource="{Binding Items}"
                           SelectionMode="None"
                           EmptyView="No inventory items">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:InventoryItemViewModel">
                        <SwipeView>
                            <!-- Swipe Actions -->
                            <SwipeView.LeftItems>
                                <SwipeItems>
                                    <SwipeItem Text="Update Qty"
                                             BackgroundColor="{StaticResource Primary}"
                                             Command="{Binding Source={RelativeSource AncestorType={x:Type vm:InventoryViewModel}}, Path=UpdateQuantityCommand}"
                                             CommandParameter="{Binding .}"/>
                                </SwipeItems>
                            </SwipeView.LeftItems>

                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Delete"
                                             BackgroundColor="{StaticResource Error}"
                                             Command="{Binding Source={RelativeSource AncestorType={x:Type vm:InventoryViewModel}}, Path=DeleteItemCommand}"
                                             CommandParameter="{Binding .}"/>
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <!-- Item Content -->
                            <Frame Margin="8,4" Padding="12" CornerRadius="8" BackgroundColor="{StaticResource White}">
                                <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="4">
                                    <!-- Product Name -->
                                    <Label Grid.Row="0" Grid.Column="0"
                                          Text="{Binding ProductName}"
                                          FontSize="18"
                                          FontAttributes="Bold"/>

                                    <!-- Quantity Badge -->
                                    <Frame Grid.Row="0" Grid.Column="1"
                                          Padding="8,4"
                                          CornerRadius="12"
                                          BackgroundColor="{StaticResource Primary}"
                                          HasShadow="False">
                                        <Label Text="{Binding Quantity, StringFormat='{0} {1}'}"
                                              TextColor="White"
                                              FontSize="14"
                                              FontAttributes="Bold"/>
                                    </Frame>

                                    <!-- Category and Location -->
                                    <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Spacing="12">
                                        <Label Text="{Binding Category}"
                                              TextColor="{StaticResource Gray600}"
                                              FontSize="14"/>
                                        <Label Text="•"
                                              TextColor="{StaticResource Gray600}"/>
                                        <Label Text="{Binding Location}"
                                              TextColor="{StaticResource Gray600}"
                                              FontSize="14"/>
                                    </HorizontalStackLayout>

                                    <!-- Expiration Date -->
                                    <Frame Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                          Padding="6,4"
                                          CornerRadius="6"
                                          BackgroundColor="{Binding ExpirationColor}"
                                          HasShadow="False"
                                          IsVisible="{Binding ExpirationDate, Converter={StaticResource IsNotNullConverter}}">
                                        <Label Text="{Binding ExpirationText}"
                                              TextColor="White"
                                              FontSize="12"
                                              FontAttributes="Bold"/>
                                    </Frame>
                                </Grid>
                            </Frame>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Add Button -->
        <Button Grid.Row="3"
               Text="+ Add Item"
               Command="{Binding AddItemCommand}"
               Margin="16"
               Padding="16"
               FontSize="18"
               FontAttributes="Bold"
               BackgroundColor="{StaticResource Primary}"
               TextColor="White"
               CornerRadius="12"/>

        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="4"
             IsVisible="{Binding IsLoading}"
             BackgroundColor="Black"
             Opacity="0.7">
            <ActivityIndicator IsRunning="True"
                              Color="{StaticResource Primary}"
                              WidthRequest="60"
                              HeightRequest="60"
                              VerticalOptions="Center"
                              HorizontalOptions="Center"/>
        </Grid>
    </Grid>
</ContentPage>
