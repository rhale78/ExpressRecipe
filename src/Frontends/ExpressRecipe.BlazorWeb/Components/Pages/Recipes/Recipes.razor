@page "/recipes"
@using Microsoft.AspNetCore.Authorization
@using ExpressRecipe.Client.Shared.Services
@using ExpressRecipe.Client.Shared.Models.Recipe
@attribute [Authorize]
@inject IRecipeApiClient RecipeApi
@inject NavigationManager Navigation

<PageTitle>Recipes - ExpressRecipe</PageTitle>

<div class="recipes-container">
    <div class="recipes-header">
        <h1>Recipe Collection</h1>
        <div class="header-actions">
            <button class="btn btn-outline" @onclick="() => Navigation.NavigateTo("/recipes/import")">
                üì• Import Recipe
            </button>
            <button class="btn btn-primary" @onclick="() => Navigation.NavigateTo("/recipes/create")">
                ‚ûï Create Recipe
            </button>
        </div>
    </div>

    <!-- Recipe Tabs -->
    <div class="recipe-tabs">
        <button class="tab-btn @(_activeTab == "all" ? "active" : "")" @onclick="() => SetActiveTab("all")">
            üçΩÔ∏è All Recipes (@_totalCount)
        </button>
        <button class="tab-btn @(_activeTab == "my" ? "active" : "")" @onclick="() => SetActiveTab("my")">
            üìù My Recipes
        </button>
        <button class="tab-btn @(_activeTab == "favorites" ? "active" : "")" @onclick="() => SetActiveTab("favorites")">
            ‚≠ê Favorites
        </button>
    </div>

    <!-- Search and Filters -->
    <div class="search-section">
        <div class="search-bar">
            <input type="text"
                   class="search-input"
                   placeholder="Search recipes by name, ingredients, or tags..."
                   @bind="_searchTerm"
                   @bind:event="oninput"
                   @onkeypress="HandleSearchKeyPress" />
            <button class="btn btn-primary" @onclick="SearchRecipes">
                üîç Search
            </button>
        </div>

        <!-- Filters Row -->
        <div class="filters-row">
            <div class="filter-group">
                <label>Difficulty</label>
                <select class="filter-select" @bind="_difficultyFilter">
                    <option value="">Any</option>
                    <option value="Easy">Easy</option>
                    <option value="Medium">Medium</option>
                    <option value="Hard">Hard</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Max Prep Time</label>
                <select class="filter-select" @bind="_maxPrepTime">
                    <option value="0">Any</option>
                    <option value="15">15 min</option>
                    <option value="30">30 min</option>
                    <option value="45">45 min</option>
                    <option value="60">1 hour</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Max Cook Time</label>
                <select class="filter-select" @bind="_maxCookTime">
                    <option value="0">Any</option>
                    <option value="30">30 min</option>
                    <option value="60">1 hour</option>
                    <option value="120">2 hours</option>
                    <option value="240">4 hours</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Sort By</label>
                <select class="filter-select" @bind="_sortBy">
                    <option value="CreatedAt">Newest First</option>
                    <option value="ViewCount">Most Popular</option>
                    <option value="FavoriteCount">Most Favorited</option>
                    <option value="Title">Alphabetical</option>
                </select>
            </div>
        </div>

        <!-- Dietary Filters -->
        <div class="dietary-filters">
            <label class="filter-section-label">Dietary Preferences</label>
            <div class="dietary-checkboxes">
                @foreach (var diet in _dietaryOptions)
                {
                    <label class="dietary-checkbox">
                        <input type="checkbox"
                               @bind="_selectedDietary[diet]" />
                        <span>@diet</span>
                    </label>
                }
            </div>
        </div>

        <!-- Allergen Exclusions -->
        <div class="allergen-filters">
            <label class="filter-section-label">Exclude Allergens</label>
            <div class="allergen-checkboxes">
                @foreach (var allergen in _commonAllergens)
                {
                    <label class="allergen-checkbox">
                        <input type="checkbox"
                               @bind="_excludedAllergens[allergen]" />
                        <span>@allergen</span>
                    </label>
                }
            </div>
        </div>

        <div class="filter-actions">
            <button class="btn btn-outline" @onclick="ClearFilters">Clear Filters</button>
            <button class="btn btn-primary" @onclick="SearchRecipes">Apply Filters</button>
        </div>
    </div>

    <!-- Loading State -->
    @if (_isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading recipes...</p>
        </div>
    }
    else if (_searchResult != null)
    {
        <!-- Results Summary -->
        <div class="results-summary">
            <p>
                Showing @_searchResult.Recipes.Count of @_searchResult.TotalCount.ToString("N0") recipes
            </p>
        </div>

        <!-- Recipe Grid -->
        @if (_searchResult.Recipes.Any())
        {
            <div class="recipes-grid">
                @foreach (var recipe in _searchResult.Recipes)
                {
                    <div class="recipe-card" @onclick="() => ViewRecipe(recipe.Id)">
                        <div class="recipe-image">
                            @if (!string.IsNullOrEmpty(recipe.ImageUrl))
                            {
                                <img src="@recipe.ImageUrl" alt="@recipe.Title" />
                            }
                            else
                            {
                                <div class="recipe-image-placeholder">üçΩÔ∏è</div>
                            }
                            <div class="recipe-difficulty-badge @recipe.Difficulty.ToLower()">
                                @recipe.Difficulty
                            </div>
                        </div>

                        <div class="recipe-info">
                            <h3 class="recipe-title">@recipe.Title</h3>
                            <p class="recipe-description">@TruncateDescription(recipe.Description, 100)</p>

                            <div class="recipe-meta">
                                <span class="meta-item">
                                    <span class="meta-icon">‚è±Ô∏è</span>
                                    @recipe.TotalTimeMinutes min
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon">üç¥</span>
                                    @recipe.Servings servings
                                </span>
                                @if (recipe.FavoriteCount > 0)
                                {
                                    <span class="meta-item">
                                        <span class="meta-icon">‚≠ê</span>
                                        @recipe.FavoriteCount
                                    </span>
                                }
                            </div>

                            @if (recipe.Tags.Any())
                            {
                                <div class="recipe-tags">
                                    @foreach (var tag in recipe.Tags.Take(3))
                                    {
                                        <span class="recipe-tag">@tag</span>
                                    }
                                    @if (recipe.Tags.Count > 3)
                                    {
                                        <span class="recipe-tag">+@(recipe.Tags.Count - 3)</span>
                                    }
                                </div>
                            }

                            @if (recipe.DietaryInfo.Any())
                            {
                                <div class="dietary-badges">
                                    @foreach (var diet in recipe.DietaryInfo.Take(3))
                                    {
                                        <span class="dietary-badge">@diet</span>
                                    }
                                </div>
                            }
                        </div>

                        <div class="recipe-footer">
                            <button class="btn-link" @onclick:stopPropagation="true" @onclick="() => ViewRecipe(recipe.Id)">
                                View Recipe ‚Üí
                            </button>
                        </div>
                    </div>
                }
            </div>

            <!-- Pagination -->
            @if (_searchResult.TotalPages > 1)
            {
                <div class="pagination">
                    <button class="btn btn-outline"
                            @onclick="() => ChangePage(_currentPage - 1)"
                            disabled="@(_currentPage <= 1)">
                        ‚Üê Previous
                    </button>

                    <div class="page-numbers">
                        @for (int i = Math.Max(1, _currentPage - 2); i <= Math.Min(_searchResult.TotalPages, _currentPage + 2); i++)
                        {
                            var page = i;
                            <button class="page-number @(page == _currentPage ? "active" : "")"
                                    @onclick="() => ChangePage(page)">
                                @page
                            </button>
                        }
                    </div>

                    <button class="btn btn-outline"
                            @onclick="() => ChangePage(_currentPage + 1)"
                            disabled="@(_currentPage >= _searchResult.TotalPages)">
                        Next ‚Üí
                    </button>
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon">üîç</div>
                <h2>No recipes found</h2>
                <p>Try adjusting your filters or create a new recipe!</p>
                <div class="empty-actions">
                    <button class="btn btn-outline" @onclick="ClearFilters">Clear Filters</button>
                    <button class="btn btn-primary" @onclick="() => Navigation.NavigateTo("/recipes/create")">
                        Create Recipe
                    </button>
                </div>
            </div>
        }
    }

    <!-- Error Message -->
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-error">
            <strong>Error:</strong> @_errorMessage
        </div>
    }
</div>

@code {
    private string _activeTab = "all";
    private string _searchTerm = string.Empty;
    private string _difficultyFilter = string.Empty;
    private int _maxPrepTime = 0;
    private int _maxCookTime = 0;
    private string _sortBy = "CreatedAt";

    private Dictionary<string, bool> _selectedDietary = new();
    private Dictionary<string, bool> _excludedAllergens = new();

    private readonly string[] _dietaryOptions = new[]
    {
        "Vegetarian", "Vegan", "Gluten-Free", "Dairy-Free",
        "Keto", "Paleo", "Low-Carb", "Low-Fat"
    };

    private readonly string[] _commonAllergens = new[]
    {
        "Dairy", "Eggs", "Fish", "Shellfish", "Tree Nuts",
        "Peanuts", "Wheat", "Soy", "Sesame"
    };

    private RecipeSearchResult? _searchResult;
    private int _currentPage = 1;
    private int _totalCount = 0;
    private const int _pageSize = 12;
    private bool _isLoading = false;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        // Initialize dietary checkboxes
        foreach (var diet in _dietaryOptions)
        {
            _selectedDietary[diet] = false;
        }

        // Initialize allergen checkboxes
        foreach (var allergen in _commonAllergens)
        {
            _excludedAllergens[allergen] = false;
        }

        // Load initial recipes
        await SearchRecipes();
    }

    private async Task SetActiveTab(string tab)
    {
        _activeTab = tab;
        _currentPage = 1;
        await LoadRecipesForTab();
    }

    private async Task LoadRecipesForTab()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            if (_activeTab == "my")
            {
                var recipes = await RecipeApi.GetMyRecipesAsync(_currentPage, _pageSize);
                _searchResult = new RecipeSearchResult
                {
                    Recipes = recipes ?? new(),
                    TotalCount = recipes?.Count ?? 0,
                    Page = _currentPage,
                    PageSize = _pageSize
                };
            }
            else if (_activeTab == "favorites")
            {
                var recipes = await RecipeApi.GetFavoriteRecipesAsync(_currentPage, _pageSize);
                _searchResult = new RecipeSearchResult
                {
                    Recipes = recipes ?? new(),
                    TotalCount = recipes?.Count ?? 0,
                    Page = _currentPage,
                    PageSize = _pageSize
                };
            }
            else
            {
                await SearchRecipes();
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load recipes: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SearchRecipes()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var request = new RecipeSearchRequest
            {
                SearchTerm = string.IsNullOrWhiteSpace(_searchTerm) ? null : _searchTerm,
                Difficulty = string.IsNullOrWhiteSpace(_difficultyFilter) ? null : _difficultyFilter,
                MaxPrepTime = _maxPrepTime > 0 ? _maxPrepTime : null,
                MaxCookTime = _maxCookTime > 0 ? _maxCookTime : null,
                DietaryInfo = _selectedDietary.Where(x => x.Value).Select(x => x.Key).ToList(),
                ExcludeAllergens = _excludedAllergens.Where(x => x.Value).Select(x => x.Key).ToList(),
                Page = _currentPage,
                PageSize = _pageSize,
                SortBy = _sortBy,
                SortDescending = _sortBy != "Title"
            };

            _searchResult = await RecipeApi.SearchRecipesAsync(request);
            _totalCount = _searchResult?.TotalCount ?? 0;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to search recipes: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _currentPage = 1;
            await SearchRecipes();
        }
    }

    private async Task ChangePage(int newPage)
    {
        if (newPage < 1 || (_searchResult != null && newPage > _searchResult.TotalPages))
            return;

        _currentPage = newPage;

        if (_activeTab == "all")
        {
            await SearchRecipes();
        }
        else
        {
            await LoadRecipesForTab();
        }
    }

    private async Task ClearFilters()
    {
        _searchTerm = string.Empty;
        _difficultyFilter = string.Empty;
        _maxPrepTime = 0;
        _maxCookTime = 0;
        _sortBy = "CreatedAt";

        foreach (var key in _selectedDietary.Keys.ToList())
        {
            _selectedDietary[key] = false;
        }

        foreach (var key in _excludedAllergens.Keys.ToList())
        {
            _excludedAllergens[key] = false;
        }

        _currentPage = 1;
        await SearchRecipes();
    }

    private void ViewRecipe(Guid recipeId)
    {
        Navigation.NavigateTo($"/recipes/{recipeId}");
    }

    private string TruncateDescription(string description, int maxLength)
    {
        if (string.IsNullOrEmpty(description) || description.Length <= maxLength)
            return description;

        return description.Substring(0, maxLength) + "...";
    }
}
