@page "/inventory/{id:guid}/edit"
@rendermode InteractiveAuto
@using ExpressRecipe.Client.Shared.Models.Inventory
@using ExpressRecipe.Client.Shared.Services
@inject IInventoryApiClient InventoryApi
@inject NavigationManager Navigation

<PageTitle>Edit Inventory Item - ExpressRecipe</PageTitle>

<div class="inventory-form-container">
    <div class="form-header">
        <button class="back-button" @onclick="NavigateBack">‚Üê Back</button>
        <h1>‚úèÔ∏è Edit Inventory Item</h1>
    </div>

    @if (_isLoading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading item...</p>
        </div>
    }
    else if (_item == null)
    {
        <div class="error-state">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3>Item Not Found</h3>
            <p>The inventory item you're looking for doesn't exist or has been deleted.</p>
            <button class="btn btn-primary" @onclick="NavigateBack">Back to Inventory</button>
        </div>
    }
    else
    {
        <div class="form-content">
            @if (_originalItem?.ProductId != null)
            {
                <div class="alert alert-info">
                    üîó This item is linked to product: <strong>@_originalItem.ProductName</strong>
                    @if (!string.IsNullOrWhiteSpace(_originalItem.ProductBrand))
                    {
                        <span> by @_originalItem.ProductBrand</span>
                    }
                </div>
            }

            <div class="form-row">
                <div class="form-group">
                    <label>Item Name *</label>
                    <input type="text" class="form-control" @bind="_item.Name"
                           placeholder="e.g., Whole Milk, Chicken Breast" />
                </div>

                <div class="form-group">
                    <label>Brand</label>
                    <input type="text" class="form-control" @bind="_item.Brand"
                           placeholder="e.g., Organic Valley" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Category</label>
                    <select class="form-control" @bind="_item.Category">
                        <option value="">Select category...</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Meat">Meat & Poultry</option>
                        <option value="Produce">Produce</option>
                        <option value="Grains">Grains & Pasta</option>
                        <option value="Canned">Canned Goods</option>
                        <option value="Frozen">Frozen Foods</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Snacks">Snacks</option>
                        <option value="Condiments">Condiments & Sauces</option>
                        <option value="Baking">Baking Supplies</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Storage Location *</label>
                    <select class="form-control" @bind="_item.Location">
                        <option value="Pantry">üè∫ Pantry</option>
                        <option value="Fridge">‚ùÑÔ∏è Fridge</option>
                        <option value="Freezer">üßä Freezer</option>
                        <option value="Other">üì¶ Other</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" step="0.1" class="form-control" @bind="_item.Quantity"
                           placeholder="e.g., 2" />
                </div>

                <div class="form-group">
                    <label>Unit *</label>
                    <select class="form-control" @bind="_item.Unit">
                        <option value="">Select unit...</option>
                        <optgroup label="Weight">
                            <option value="oz">oz (ounces)</option>
                            <option value="lb">lb (pounds)</option>
                            <option value="g">g (grams)</option>
                            <option value="kg">kg (kilograms)</option>
                        </optgroup>
                        <optgroup label="Volume">
                            <option value="fl oz">fl oz (fluid ounces)</option>
                            <option value="cup">cup</option>
                            <option value="pint">pint</option>
                            <option value="quart">quart</option>
                            <option value="gallon">gallon</option>
                            <option value="ml">ml (milliliters)</option>
                            <option value="L">L (liters)</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="count">count (individual items)</option>
                            <option value="package">package</option>
                            <option value="can">can</option>
                            <option value="jar">jar</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Purchase Date</label>
                    <input type="date" class="form-control"
                           value="@(_item.PurchaseDate?.ToString("yyyy-MM-dd"))"
                           @onchange="@(e => _item.PurchaseDate = string.IsNullOrEmpty(e.Value?.ToString()) ? null : DateTime.Parse(e.Value.ToString()!))" />
                </div>

                <div class="form-group">
                    <label>Expiration Date</label>
                    <input type="date" class="form-control"
                           value="@(_item.ExpirationDate?.ToString("yyyy-MM-dd"))"
                           @onchange="@(e => _item.ExpirationDate = string.IsNullOrEmpty(e.Value?.ToString()) ? null : DateTime.Parse(e.Value.ToString()!))" />
                    <span class="form-hint">We'll alert you when items are expiring soon</span>
                </div>
            </div>

            <div class="form-group">
                <label>Opened Date (Optional)</label>
                <input type="date" class="form-control"
                       value="@(_item.OpenedDate?.ToString("yyyy-MM-dd"))"
                       @onchange="@(e => _item.OpenedDate = string.IsNullOrEmpty(e.Value?.ToString()) ? null : DateTime.Parse(e.Value.ToString()!))" />
                <span class="form-hint">For items that expire faster once opened</span>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="_item.IsLowStock" />
                    <span>Mark as Low Stock</span>
                </label>
                <span class="form-hint">Check this to get reminders to restock</span>
            </div>

            <div class="form-group">
                <label>Notes</label>
                <textarea class="form-control" rows="3" @bind="_item.Notes"
                          placeholder="Any additional notes about this item..."></textarea>
            </div>

            <div class="form-group">
                <label>Tags (comma-separated)</label>
                <input type="text" class="form-control" @bind="_tagsInput"
                       placeholder="e.g., organic, local, gluten-free" />
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-error">
                    ‚ö†Ô∏è @_errorMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(_successMessage))
            {
                <div class="alert alert-success">
                    ‚úì @_successMessage
                </div>
            }

            <div class="form-actions">
                <button class="btn btn-secondary-outline" @onclick="NavigateBack">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveItem" disabled="@_isSaving">
                    @if (_isSaving)
                    {
                        <span class="spinner-small"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save Changes</span>
                    }
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private bool _isLoading = true;
    private InventoryItemDto? _originalItem;
    private UpdateInventoryItemRequest _item = new();
    private string _tagsInput = string.Empty;

    private bool _isSaving = false;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadItem();
    }

    private async Task LoadItem()
    {
        _isLoading = true;
        StateHasChanged();

        _originalItem = await InventoryApi.GetInventoryItemAsync(Id);

        if (_originalItem != null)
        {
            // Map to update request
            _item = new UpdateInventoryItemRequest
            {
                ProductId = _originalItem.ProductId,
                Name = _originalItem.Name,
                Brand = _originalItem.Brand,
                Category = _originalItem.Category,
                Quantity = _originalItem.Quantity,
                Unit = _originalItem.Unit,
                Location = _originalItem.Location,
                PurchaseDate = _originalItem.PurchaseDate,
                ExpirationDate = _originalItem.ExpirationDate,
                OpenedDate = _originalItem.OpenedDate,
                IsLowStock = _originalItem.IsLowStock,
                Notes = _originalItem.Notes,
                Tags = _originalItem.Tags.ToList()
            };

            _tagsInput = string.Join(", ", _originalItem.Tags);
        }

        _isLoading = false;
        StateHasChanged();
    }

    private async Task SaveItem()
    {
        _errorMessage = string.Empty;
        _successMessage = string.Empty;

        // Validation
        if (string.IsNullOrWhiteSpace(_item.Name))
        {
            _errorMessage = "Item name is required.";
            return;
        }

        if (_item.Quantity <= 0)
        {
            _errorMessage = "Quantity must be greater than 0.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_item.Unit))
        {
            _errorMessage = "Unit is required.";
            return;
        }

        // Parse tags
        if (!string.IsNullOrWhiteSpace(_tagsInput))
        {
            _item.Tags = _tagsInput.Split(',')
                .Select(t => t.Trim())
                .Where(t => !string.IsNullOrEmpty(t))
                .ToList();
        }
        else
        {
            _item.Tags = new();
        }

        _isSaving = true;
        StateHasChanged();

        var success = await InventoryApi.UpdateInventoryItemAsync(Id, _item);

        _isSaving = false;

        if (success)
        {
            _successMessage = "Item updated successfully!";
            StateHasChanged();

            await Task.Delay(1000);
            Navigation.NavigateTo("/inventory");
        }
        else
        {
            _errorMessage = "Failed to update item. Please try again.";
            StateHasChanged();
        }
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/inventory");
    }
}
