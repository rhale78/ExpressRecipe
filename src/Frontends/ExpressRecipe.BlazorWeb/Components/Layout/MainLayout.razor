@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject IAuthService AuthService

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h1 class="logo">ğŸ½ï¸ ExpressRecipe</h1>
        </div>

        <nav class="sidebar-nav">
            <AuthorizeView>
                <Authorized>
                    <a href="/dashboard" class="nav-link @GetActiveClass("/dashboard")">
                        <span class="nav-icon">ğŸ </span>
                        <span class="nav-text">Dashboard</span>
                    </a>

                    <a href="/products" class="nav-link @GetActiveClass("/products")">
                        <span class="nav-icon">ğŸ“¦</span>
                        <span class="nav-text">Products</span>
                    </a>

                    <a href="/products/scan" class="nav-link @GetActiveClass("/products/scan")">
                        <span class="nav-icon">ğŸ“·</span>
                        <span class="nav-text">Scan Barcode</span>
                    </a>

                    <a href="/recipes" class="nav-link @GetActiveClass("/recipes")">
                        <span class="nav-icon">ğŸ³</span>
                        <span class="nav-text">Recipes</span>
                    </a>

                    <a href="/inventory" class="nav-link @GetActiveClass("/inventory")">
                        <span class="nav-icon">ğŸ“‹</span>
                        <span class="nav-text">Inventory</span>
                    </a>

                    <a href="/shopping" class="nav-link @GetActiveClass("/shopping")">
                        <span class="nav-icon">ğŸ›’</span>
                        <span class="nav-text">Shopping List</span>
                    </a>

                    <a href="/meal-planning" class="nav-link @GetActiveClass("/meal-planning")">
                        <span class="nav-icon">ğŸ“…</span>
                        <span class="nav-text">Meal Planning</span>
                    </a>

                    <div class="nav-divider"></div>

                    <a href="/settings" class="nav-link @GetActiveClass("/settings")">
                        <span class="nav-icon">âš™ï¸</span>
                        <span class="nav-text">Settings</span>
                    </a>

                    <button @onclick="HandleLogout" class="nav-link logout-btn">
                        <span class="nav-icon">ğŸšª</span>
                        <span class="nav-text">Logout</span>
                    </button>
                </Authorized>
                <NotAuthorized>
                    <a href="/login" class="nav-link">
                        <span class="nav-icon">ğŸ”</span>
                        <span class="nav-text">Login</span>
                    </a>
                    <a href="/register" class="nav-link">
                        <span class="nav-icon">âœ¨</span>
                        <span class="nav-text">Register</span>
                    </a>
                </NotAuthorized>
            </AuthorizeView>
        </nav>
    </div>

    <div class="main-content">
        <header class="top-bar">
            <AuthorizeView>
                <Authorized>
                    <div class="user-info">
                        <span class="user-avatar">@GetUserInitials(context)</span>
                        <span class="user-name">@context.User.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value</span>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <div class="user-info">
                        <a href="/login" class="btn btn-outline">Login</a>
                        <a href="/register" class="btn btn-primary">Sign Up</a>
                    </div>
                </NotAuthorized>
            </AuthorizeView>
        </header>

        <main class="page-content">
            @Body
        </main>
    </div>
</div>

@code {
    private string GetActiveClass(string path)
    {
        return Navigation.Uri.Contains(path, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    }

    private string GetUserInitials(AuthenticationState context)
    {
        var firstName = context.User.FindFirst(System.Security.Claims.ClaimTypes.GivenName)?.Value ?? "";
        var lastName = context.User.FindFirst(System.Security.Claims.ClaimTypes.Surname)?.Value ?? "";

        return $"{(firstName.Length > 0 ? firstName[0] : "")}{(lastName.Length > 0 ? lastName[0] : "")}".ToUpper();
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }
}
